{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/auth/index.js","webpack:///./src/auth/router.js","webpack:///./src/auth/store.js","webpack:///./src/index.js","webpack:///./src/pois/index.js","webpack:///./src/pois/router.js","webpack:///./src/pois/store.js","webpack:///./src/utils/constants.js","webpack:///./src/utils/index.js","webpack:///./src/utils/middlewares.js","webpack:///./src/utils/wss.js","webpack:///external \"@koa/cors\"","webpack:///external \"http\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-jwt\"","webpack:///external \"koa-router\"","webpack:///external \"nedb-promise\"","webpack:///external \"ws\""],"names":["router","Router","createToken","user","jwt","sign","username","_id","jwtConfig","secret","expiresIn","createUser","response","userStore","insert","body","token","status","err","issue","error","message","post","ctx","request","console","log","credentials","findOne","password","UserStore","constructor","filename","autoload","store","dataStore","props","app","Koa","server","http","createServer","callback","wss","WebSocket","Server","initWss","use","cors","timingLogger","exceptionHandler","bodyParser","prefix","publicApiRouter","authRouter","routes","allowedMethods","protectedApiRouter","poiRouter","listen","get","userId","state","poiStore","find","poi","params","id","createPoi","broadcast","type","payload","put","poiId","updatedCount","update","del","remove","PoiStore","poiName","name","Error","next","start","Date","now","method","url","value","on","ws","JSON","parse","close","verify","data","clients","forEach","client","readyState","OPEN","send","stringify"],"mappings":"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AkBX,IAAlB,CAAP;AACD;;AAXoB;AAcR,mEAAI2B,SAAJ,CAAc;AAAEE,UAAQ,EAAE,iBAAZ;AAA+BC,UAAQ,EAAE;AAAzC,CAAd,CAAf,E;;;;;;;;;;;;AChBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,MAAMI,GAAG,GAAG,IAAIC,0CAAJ,EAAZ;AACA,MAAMC,MAAM,GAAGC,2CAAI,CAACC,YAAL,CAAkBJ,GAAG,CAACK,QAAJ,EAAlB,CAAf;AACA,MAAMC,GAAG,GAAG,IAAIC,yCAAS,CAACC,MAAd,CAAqB;AAAEN;AAAF,CAArB,CAAZ;AACAO,sDAAO,CAACH,GAAD,CAAP;AAEAN,GAAG,CAACU,GAAJ,CAAQC,gDAAI,EAAZ;AACAX,GAAG,CAACU,GAAJ,CAAQE,mDAAR;AACAZ,GAAG,CAACU,GAAJ,CAAQG,uDAAR;AACAb,GAAG,CAACU,GAAJ,CAAQI,qDAAU,EAAlB;AAEA,MAAMC,MAAM,GAAG,MAAf,C,CAEA;;AACA,MAAMC,eAAe,GAAG,IAAIpD,iDAAJ,CAAW;AAAEmD;AAAF,CAAX,CAAxB;AACAC,eAAe,CACVN,GADL,CACS,OADT,EACkBO,4CAAU,CAACC,MAAX,EADlB;AAEAlB,GAAG,CACEU,GADL,CACSM,eAAe,CAACE,MAAhB,EADT,EAEKR,GAFL,CAESM,eAAe,CAACG,cAAhB,EAFT;AAIAnB,GAAG,CAACU,GAAJ,CAAQ3C,8CAAG,CAACI,gDAAD,CAAX,E,CAEA;;AACA,MAAMiD,kBAAkB,GAAG,IAAIxD,iDAAJ,CAAW;AAAEmD;AAAF,CAAX,CAA3B;AACAK,kBAAkB,CACbV,GADL,CACS,MADT,EACiBW,4CAAS,CAACH,MAAV,EADjB;AAEAlB,GAAG,CACEU,GADL,CACSU,kBAAkB,CAACF,MAAnB,EADT,EAEKR,GAFL,CAESU,kBAAkB,CAACD,cAAnB,EAFT;AAIAjB,MAAM,CAACoB,MAAP,CAAc,IAAd;AACAlC,OAAO,CAACC,GAAR,CAAY,sBAAZ,E;;;;;;;;;;;;ACtNA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEO,MAAM1B,MAAM,GAAG,IAAIC,iDAAJ,EAAf,C,CAEP;AACA;AACA;AACA;AACA;AACA;;AAEAD,MAAM,CAAC4D,GAAP,CAAW,GAAX,EAAgB,MAAOrC,GAAP,IAAe;AAC3BE,SAAO,CAACC,GAAR,CAAYH,GAAG,CAACX,QAAhB;AACA,QAAMA,QAAQ,GAAGW,GAAG,CAACX,QAArB;AACA,QAAMiD,MAAM,GAAGtC,GAAG,CAACuC,KAAJ,CAAU3D,IAAV,CAAeI,GAA9B;AACAK,UAAQ,CAACG,IAAT,GAAgB,MAAMgD,8CAAQ,CAACC,IAAT,CAAc;AAACH;AAAD,GAAd,CAAtB;AACAjD,UAAQ,CAACK,MAAT,GAAkB,GAAlB,CAL2B,CAKJ;AAC1B,CAND;AAQAjB,MAAM,CAAC4D,GAAP,CAAW,MAAX,EAAmB,MAAOrC,GAAP,IAAe;AAC9B,QAAMsC,MAAM,GAAGtC,GAAG,CAACuC,KAAJ,CAAU3D,IAAV,CAAeI,GAA9B;AACA,QAAM0D,GAAG,GAAG,MAAMF,8CAAQ,CAACnC,OAAT,CAAiB;AAACrB,OAAG,EAAEgB,GAAG,CAAC2C,MAAJ,CAAWC;AAAjB,GAAjB,CAAlB;AACA,QAAMvD,QAAQ,GAAGW,GAAG,CAACX,QAArB;;AACA,MAAIqD,GAAJ,EAAS;AACL,QAAIA,GAAG,CAACJ,MAAJ,KAAeA,MAAnB,EAA2B;AACvBjD,cAAQ,CAACG,IAAT,GAAgBkD,GAAhB;AACArD,cAAQ,CAACK,MAAT,GAAkB,GAAlB,CAFuB,CAEA;AAC1B,KAHD,MAGO;AACHL,cAAQ,CAACK,MAAT,GAAkB,GAAlB,CADG,CACoB;AAC1B;AACJ,GAPD,MAOO;AACHL,YAAQ,CAACK,MAAT,GAAkB,GAAlB,CADG,CACoB;AAC1B;AACJ,CAdD;;AAgBA,MAAMmD,SAAS,GAAG,OAAO7C,GAAP,EAAY0C,GAAZ,EAAiBrD,QAAjB,KAA8B;AAC5C,MAAI;AACA,UAAMiD,MAAM,GAAGtC,GAAG,CAACuC,KAAJ,CAAU3D,IAAV,CAAeI,GAA9B;AACA0D,OAAG,CAACJ,MAAJ,GAAaA,MAAb;AACAjD,YAAQ,CAACG,IAAT,GAAgB,MAAMgD,8CAAQ,CAACjD,MAAT,CAAgBmD,GAAhB,CAAtB;AACArD,YAAQ,CAACK,MAAT,GAAkB,GAAlB,CAJA,CAIuB;;AACvBoD,4DAAS,CAACR,MAAD,EAAS;AAACS,UAAI,EAAE,SAAP;AAAkBC,aAAO,EAAEN;AAA3B,KAAT,CAAT;AACH,GAND,CAME,OAAO/C,GAAP,EAAY;AACVN,YAAQ,CAACG,IAAT,GAAgB;AAACM,aAAO,EAAEH,GAAG,CAACG;AAAd,KAAhB;AACAT,YAAQ,CAACK,MAAT,GAAkB,GAAlB,CAFU,CAEa;AAC1B;AACJ,CAXD;;AAaAjB,MAAM,CAACsB,IAAP,CAAY,GAAZ,EAAiB,MAAMC,GAAN,IAAa,MAAM6C,SAAS,CAAC7C,GAAD,EAAMA,GAAG,CAACC,OAAJ,CAAYT,IAAlB,EAAwBQ,GAAG,CAACX,QAA5B,CAA7C;AAEAZ,MAAM,CAACwE,GAAP,CAAW,MAAX,EAAmB,MAAOjD,GAAP,IAAe;AAE9B;AACA;AACA;AACA;AACA;AAEA,QAAM0C,GAAG,GAAG1C,GAAG,CAACC,OAAJ,CAAYT,IAAxB;AACA,QAAMoD,EAAE,GAAG5C,GAAG,CAAC2C,MAAJ,CAAWC,EAAtB;AACA,QAAMM,KAAK,GAAGR,GAAG,CAAC1D,GAAlB;AACA,QAAMK,QAAQ,GAAGW,GAAG,CAACX,QAArB;;AACA,MAAI6D,KAAK,IAAIA,KAAK,KAAKN,EAAvB,EAA2B;AACvBvD,YAAQ,CAACG,IAAT,GAAgB;AAACM,aAAO,EAAE;AAAV,KAAhB;AACAT,YAAQ,CAACK,MAAT,GAAkB,GAAlB,CAFuB,CAEA;;AACvB;AACH;;AACD,MAAI,CAACwD,KAAL,EAAY;AACR,UAAML,SAAS,CAAC7C,GAAD,EAAM0C,GAAN,EAAWrD,QAAX,CAAf;AACH,GAFD,MAEO;AACH,UAAMiD,MAAM,GAAGtC,GAAG,CAACuC,KAAJ,CAAU3D,IAAV,CAAeI,GAA9B;AACA0D,OAAG,CAACJ,MAAJ,GAAaA,MAAb,CAFG,CAIH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,UAAMa,YAAY,GAAG,MAAMX,8CAAQ,CAACY,MAAT,CAAgB;AAACpE,SAAG,EAAE4D;AAAN,KAAhB,EAA2BF,GAA3B,CAA3B;;AACA,QAAIS,YAAY,KAAK,CAArB,EAAwB;AACpB9D,cAAQ,CAACG,IAAT,GAAgBkD,GAAhB;AACArD,cAAQ,CAACK,MAAT,GAAkB,GAAlB,CAFoB,CAEG;;AACvBoD,8DAAS,CAACR,MAAD,EAAS;AAACS,YAAI,EAAE,SAAP;AAAkBC,eAAO,EAAEN;AAA3B,OAAT,CAAT;AACH,KAJD,MAIO;AACHrD,cAAQ,CAACG,IAAT,GAAgB;AAACM,eAAO,EAAE;AAAV,OAAhB;AACAT,cAAQ,CAACK,MAAT,GAAkB,GAAlB,CAFG,CAEoB;AAC1B;AACJ;AACJ,CA3CD;AA6CAjB,MAAM,CAAC4E,GAAP,CAAW,MAAX,EAAmB,MAAOrD,GAAP,IAAe;AAC9B,QAAMsC,MAAM,GAAGtC,GAAG,CAACuC,KAAJ,CAAU3D,IAAV,CAAeI,GAA9B;AACA,QAAM0D,GAAG,GAAG,MAAMF,8CAAQ,CAACnC,OAAT,CAAiB;AAACrB,OAAG,EAAEgB,GAAG,CAAC2C,MAAJ,CAAWC;AAAjB,GAAjB,CAAlB;;AACA,MAAIF,GAAG,IAAIJ,MAAM,KAAKI,GAAG,CAACJ,MAA1B,EAAkC;AAC9BtC,OAAG,CAACX,QAAJ,CAAaK,MAAb,GAAsB,GAAtB,CAD8B,CACH;AAC9B,GAFD,MAEO;AACH,UAAM8C,8CAAQ,CAACc,MAAT,CAAgB;AAACtE,SAAG,EAAEgB,GAAG,CAAC2C,MAAJ,CAAWC;AAAjB,KAAhB,CAAN;AACA5C,OAAG,CAACX,QAAJ,CAAaK,MAAb,GAAsB,GAAtB,CAFG,CAEwB;AAC9B;AACJ,CATD,E;;;;;;;;;;;;ACjGA;AAAA;AAAA;AAAA;AAAA;AAEO,MAAM6D,QAAN,CAAe;AACpB/C,aAAW,CAAC;AAAEC,YAAF;AAAYC;AAAZ,GAAD,EAAyB;AAClC,SAAKC,KAAL,GAAaC,mDAAS,CAAC;AAAEH,cAAF;AAAYC;AAAZ,KAAD,CAAtB;AACD;;AAED,QAAM+B,IAAN,CAAW5B,KAAX,EAAkB;AAChB,WAAO,KAAKF,KAAL,CAAW8B,IAAX,CAAgB5B,KAAhB,CAAP;AACD;;AAED,QAAMR,OAAN,CAAcQ,KAAd,EAAqB;AACnB,WAAO,KAAKF,KAAL,CAAWN,OAAX,CAAmBQ,KAAnB,CAAP;AACD;;AAED,QAAMtB,MAAN,CAAamD,GAAb,EAAkB;AAChB,QAAIc,OAAO,GAAGd,GAAG,CAACe,IAAlB;;AACA,QAAI,CAACD,OAAL,EAAc;AAAE;AACd,YAAM,IAAIE,KAAJ,CAAU,2BAAV,CAAN;AACD;;AACD,WAAO,KAAK/C,KAAL,CAAWpB,MAAX,CAAkBmD,GAAlB,CAAP;AACD;;AAED,QAAMU,MAAN,CAAavC,KAAb,EAAoB6B,GAApB,EAAyB;AACvB,WAAO,KAAK/B,KAAL,CAAWyC,MAAX,CAAkBvC,KAAlB,EAAyB6B,GAAzB,CAAP;AACD;;AAED,QAAMY,MAAN,CAAazC,KAAb,EAAoB;AAClB,WAAO,KAAKF,KAAL,CAAW2C,MAAX,CAAkBzC,KAAlB,CAAP;AACD;;AA3BmB;AA8BP,mEAAI0C,QAAJ,CAAa;AAAE9C,UAAQ,EAAE,gBAAZ;AAA8BC,UAAQ,EAAE;AAAxC,CAAb,CAAf,E;;;;;;;;;;;;AChCA;AAAA;AAAO,MAAMzB,SAAS,GAAG;AAAEC,QAAM,EAAE;AAAV,CAAlB,C;;;;;;;;;;;;ACAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;ACDA;AAAA;AAAA;AAAO,MAAMyC,gBAAgB,GAAG,OAAO3B,GAAP,EAAY2D,IAAZ,KAAqB;AACnD,MAAI;AACF,WAAO,MAAMA,IAAI,EAAjB;AACD,GAFD,CAEE,OAAOhE,GAAP,EAAY;AACZK,OAAG,CAACR,IAAJ,GAAW;AAAEM,aAAO,EAAEH,GAAG,CAACG,OAAJ,IAAe;AAA1B,KAAX;AACAE,OAAG,CAACN,MAAJ,GAAaC,GAAG,CAACD,MAAJ,IAAc,GAA3B;AACD;AACF,CAPM;AASA,MAAMgC,YAAY,GAAG,OAAO1B,GAAP,EAAY2D,IAAZ,KAAqB;AAC/C,QAAMC,KAAK,GAAGC,IAAI,CAACC,GAAL,EAAd;AACA,QAAMH,IAAI,EAAV;AACAzD,SAAO,CAACC,GAAR,CAAa,GAAEH,GAAG,CAAC+D,MAAO,IAAG/D,GAAG,CAACgE,GAAI,OAAMhE,GAAG,CAACX,QAAJ,CAAaK,MAAO,KAAImE,IAAI,CAACC,GAAL,KAAaF,KAAM,IAAtF;AACD,CAJM,C;;;;;;;;;;;;ACTP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA,IAAIxC,GAAJ;AAEO,MAAMG,OAAO,GAAG0C,KAAK,IAAI;AAC9B7C,KAAG,GAAG6C,KAAN;AACA7C,KAAG,CAAC8C,EAAJ,CAAO,YAAP,EAAqBC,EAAE,IAAI;AACzBA,MAAE,CAACD,EAAH,CAAM,SAAN,EAAiBpE,OAAO,IAAI;AAC1B,YAAM;AAAEiD,YAAF;AAAQC,eAAO,EAAE;AAAEvD;AAAF;AAAjB,UAA+B2E,IAAI,CAACC,KAAL,CAAWvE,OAAX,CAArC;;AACA,UAAIiD,IAAI,KAAK,eAAb,EAA8B;AAC5BoB,UAAE,CAACG,KAAH;AACA;AACD;;AACD,UAAI;AACFH,UAAE,CAACvF,IAAH,GAAUC,mDAAG,CAAC0F,MAAJ,CAAW9E,KAAX,EAAkBR,oDAAS,CAACC,MAA5B,CAAV;AACD,OAFD,CAEE,OAAOS,GAAP,EAAY;AACZwE,UAAE,CAACG,KAAH;AACD;AACF,KAXD;AAYD,GAbD;AAcD,CAhBM;AAkBA,MAAMxB,SAAS,GAAG,CAACR,MAAD,EAASkC,IAAT,KAAkB;AACzC,MAAI,CAACpD,GAAL,EAAU;AACR;AACD;;AACDA,KAAG,CAACqD,OAAJ,CAAYC,OAAZ,CAAoBC,MAAM,IAAI;AAC5B,QAAIA,MAAM,CAACC,UAAP,KAAsBvD,yCAAS,CAACwD,IAAhC,IAAwCvC,MAAM,KAAKqC,MAAM,CAAC/F,IAAP,CAAYI,GAAnE,EAAwE;AACtEkB,aAAO,CAACC,GAAR,CAAa,qBAAoBwE,MAAM,CAAC/F,IAAP,CAAYG,QAAS,EAAtD;AACA4F,YAAM,CAACG,IAAP,CAAYV,IAAI,CAACW,SAAL,CAAeP,IAAf,CAAZ;AACD;AACF,GALD;AAMD,CAVM,C;;;;;;;;;;;;;;;;;;;;;;;ACxBP,sC;;;;;;;;;;;ACAA,iC;;;;;;;;;;;ACAA,yC;;;;;;;;;;;ACAA,gC;;;;;;;;;;;ACAA,2C;;;;;;;;;;;ACAA,oC;;;;;;;;;;;ACAA,uC;;;;;;;;;;;ACAA,yC;;;;;;;;;;;ACAA,+B","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export * from './router';","import Router from 'koa-router';\r\nimport userStore from './store';\r\nimport jwt from 'jsonwebtoken';\r\nimport { jwtConfig } from '../utils';\r\n\r\nexport const router = new Router();\r\n\r\nconst createToken = (user) => {\r\n  return jwt.sign({ username: user.username, _id: user._id }, jwtConfig.secret, { expiresIn: 60 * 60 * 60 });\r\n};\r\n\r\nconst createUser = async (user, response) => {\r\n  try {\r\n    await userStore.insert(user);\r\n    response.body = { token: createToken(user) };\r\n    response.status = 201; // created\r\n  } catch (err) {\r\n    response.body = { issue: [{ error: err.message }] };\r\n    response.status = 400; // bad request\r\n  }\r\n};\r\n\r\nrouter.post('/signup', async (ctx) => await createUser(ctx.request.body, ctx.response));\r\n\r\nrouter.post('/login', async (ctx) => {\r\n  console.log(ctx.request.body)\r\n  const credentials = ctx.request.body;\r\n  const response = ctx.response;\r\n  const user = await userStore.findOne({ username: credentials.username });\r\n  if (user && credentials.password === user.password) {\r\n    response.body = { token: createToken(user) };\r\n    response.status = 201; // created\r\n  } else {\r\n    response.body = { issue: [{ error: 'Invalid credentials' }] };\r\n    response.status = 400; // bad request\r\n  }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class UserStore {\r\n  constructor({ filename, autoload }) {\r\n    this.store = dataStore({ filename, autoload });\r\n  }\r\n  \r\n  async findOne(props) {\r\n    return this.store.findOne(props);\r\n  }\r\n  \r\n  async insert(user) {\r\n    return this.store.insert(user);\r\n  };\r\n}\r\n\r\nexport default new UserStore({ filename: './db/users.json', autoload: true });","// const Koa = require('koa');\n// const app = new Koa();\n// const server = require('http').createServer(app.callback());\n// const WebSocket = require('ws');\n// const wss = new WebSocket.Server({server});\n// const Router = require('koa-router');\n// const cors = require('koa-cors');\n// const bodyparser = require('koa-bodyparser');\n//\n// app.use(bodyparser());\n// app.use(cors());\n// app.use(async (ctx, next) => {\n//     const start = new Date();\n//     await next();\n//     const ms = new Date() - start;\n//     console.log(`${ctx.method} ${ctx.url} ${ctx.response.status} - ${ms}`);\n// });\n//\n// app.use(async (ctx, next) => {\n//     try {\n//         await next();\n//     } catch (err) {\n//         ctx.response.body = {issue: [{error: err.message || 'Unexpected error'}]};\n//         ctx.response.status = 500;\n//     }\n// });\n//\n// class Asteroid {\n//     constructor({id, name, diameter, discoveryDate, fromKuiperBelt}) {\n//         this.id = id;\n//         this.name = name;\n//         this.diameter = diameter;\n//         this.discoveryDate = discoveryDate;\n//         this.fromKuiperBelt = fromKuiperBelt;\n//     }\n// }\n//\n// var pois = [];\n// pois.push(new Asteroid({id: 1, name: \"Ceres\", diameter: 952, discoveryDate: \"01-01-1801\", fromKuiperBelt: false}));\n// pois.push(new Asteroid({\n//     id: 2,\n//     name: \"Herculina\",\n//     diameter: 209,\n//     discoveryDate: \"20-04-1904\",\n//     fromKuiperBelt: true\n// }));\n// pois.push(new Asteroid({\n//     id: 3,\n//     name: \"Nemesis\",\n//     diameter: 189,\n//     discoveryDate: \"25-11-1872\",\n//     fromKuiperBelt: true\n// }));\n// pois.push(new Asteroid({\n//     id: 4,\n//     name: \"DELETE ME\",\n//     diameter: 94327,\n//     discoveryDate: \"12-12-2012\",\n//     fromKuiperBelt: false\n// }));\n//\n// const router = new Router();\n//\n// router.get('/pois', ctx => {\n//     const ifModifiedSince = ctx.request.get('If-Modif ied-Since');\n//     // if (ifModifiedSince && new Date(ifModifiedSince).getTime() >= lastUpdated.getTime() - lastUpdated.getMilliseconds()) {\n//     //     console.log(\"NOT MODIFIED\")\n//     //     ctx.response.status = 304; // NOT MODIFIED\n//     //     return;\n//     // }\n//     //  const text = ctx.request.query.text;\n//     //  const page = parseInt(ctx.request.query.page) || 1;\n//\n//     // ctx.response.set('Last-Modified', lastUpdated.toUTCString());\n//\n//     // const sortedItems = pois\n//     //     .filter(asteroid => text ? item.text.indexOf(text) !== -1 : true)\n//     //     .sort((n1, n2) => -(n1.date.getTime() - n2.date.getTime()));\n//     // const offset = (page - 1) * pageSize;\n//     // ctx.response.body = {\n//     //   page,\n//     //   items: sortedItems.slice(offset, offset + pageSize),\n//     //   more: offset + pageSize < sortedItems.length\n//     // };\n//     ctx.response.body = pois;\n//     ctx.response.status = 200;\n// });\n//\n// router.get('/asteroid/:id', async (ctx) => {\n//     const asteroidId = ctx.request.params.id;\n//     const asteroid = items.find(asteroid => asteroidId === asteroid.id);\n//     if (asteroid) {\n//         ctx.response.body = asteroid;\n//         ctx.response.status = 200; // ok\n//     } else {\n//         ctx.response.body = { issue: [{ warning: `asteroid with id ${asteroidIdId} not found` }] };\n//         ctx.response.status = 404; // NOT FOUND (if you know the resource was deleted, then return 410 GONE)\n//     }\n// });\n//\n// let lastId = pois[pois.length - 1].id;\n//\n// const createAsteroid = async (ctx) => {\n//     const asteroid = ctx.request.body;\n//     if (!asteroid.name) { // validation\n//         ctx.response.body = { issue: [{ error: 'Name is missing' }] };\n//         ctx.response.status = 400; //  BAD REQUEST\n//         return;\n//     }\n//     asteroid.id = `${parseInt(lastId) + 1}`;\n//     lastId = asteroid.id;\n//     pois.push(asteroid);\n//     ctx.response.body = item;\n//     ctx.response.status = 201; // CREATED\n//     broadcast({ event: 'created', payload: { item } });\n// };\n//\n// router.post('/asteroid', async (ctx) => {\n//     await createAsteroid(ctx);\n// });\n//\n// router.put('/asteroid/:id', async (ctx) => {\n//     const id = ctx.params.id;\n//     const asteroid = ctx.request.body;\n//     const asteroidId = item.id;\n//     if (asteroidId && id !== asteroid.id) {\n//         ctx.response.body = { issue: [{ error: `Param id and body id should be the same` }] };\n//         ctx.response.status = 400; // BAD REQUEST\n//         return;\n//     }\n//     if (!asteroidId) {\n//         await createItem(ctx);\n//         return;\n//     }\n//     const index = pois.findIndex(asteroid => asteroid.id === id);\n//     if (index === -1) {\n//         ctx.response.body = { issue: [{ error: `asteroid with id ${id} not found` }] };\n//         ctx.response.status = 400; // BAD REQUEST\n//         return;\n//     }\n//\n//     pois[index] = asteroid;\n//     ctx.response.body = item;\n//     ctx.response.status = 200; // OK\n//     broadcast({ event: 'updated', payload: { item } });\n// });\n//\n// router.del('/pois/:id', ctx => {\n//     const id = ctx.params.id;\n//     const idx = pois.findIndex(ast => ast.id === id);\n//     if (idx !== -1) {\n//         const asteroid = pois[idx];\n//         pois.splice(idx, 1);\n//         broadcast({payload: {asteroid}});\n//     }\n//\n//     ctx.response.status = 204;\n// });\n//\n// broadcast = data => wss.clients.forEach(client => {\n//     if (client.readyState === WebSocket.OPEN) {\n//         client.send(JSON.stringify(data));\n//     }\n//\n// })\n//\n// app.use(router.routes());\n// app.use(router.allowedMethods());\n//\n// server.listen(3000);\n\n\nimport Koa from 'koa';\nimport WebSocket from 'ws';\nimport http from 'http';\nimport Router from 'koa-router';\nimport bodyParser from \"koa-bodyparser\";\nimport { timingLogger, exceptionHandler, jwtConfig, initWss, verifyClient } from './utils';\nimport { router as poiRouter } from './pois';\nimport { router as authRouter } from './auth';\nimport jwt from 'koa-jwt';\nimport cors from '@koa/cors';\n\nconst app = new Koa();\nconst server = http.createServer(app.callback());\nconst wss = new WebSocket.Server({ server });\ninitWss(wss);\n\napp.use(cors());\napp.use(timingLogger);\napp.use(exceptionHandler);\napp.use(bodyParser());\n\nconst prefix = '/api';\n\n// public\nconst publicApiRouter = new Router({ prefix });\npublicApiRouter\n    .use('/auth', authRouter.routes());\napp\n    .use(publicApiRouter.routes())\n    .use(publicApiRouter.allowedMethods());\n\napp.use(jwt(jwtConfig));\n\n// protected\nconst protectedApiRouter = new Router({ prefix });\nprotectedApiRouter\n    .use('/poi', poiRouter.routes());\napp\n    .use(protectedApiRouter.routes())\n    .use(protectedApiRouter.allowedMethods());\n\nserver.listen(3000);\nconsole.log('started on port 3000');\n","export * from './router';","import Router from 'koa-router';\r\nimport poiStore from './store';\r\nimport {broadcast} from \"../utils\";\r\n\r\nexport const router = new Router();\r\n\r\n// let lastUpdated = getLastUpdated();\r\n//\r\n// const getLastUpdated = async () => {\r\n//     const pois = await poiStore.find();\r\n//     return pois[pois.length() - 1].lastUpdated;\r\n// }\r\n\r\nrouter.get('/', async (ctx) => {\r\n    console.log(ctx.response)\r\n    const response = ctx.response;\r\n    const userId = ctx.state.user._id;\r\n    response.body = await poiStore.find({userId});\r\n    response.status = 200; // ok\r\n});\r\n\r\nrouter.get('/:id', async (ctx) => {\r\n    const userId = ctx.state.user._id;\r\n    const poi = await poiStore.findOne({_id: ctx.params.id});\r\n    const response = ctx.response;\r\n    if (poi) {\r\n        if (poi.userId === userId) {\r\n            response.body = poi;\r\n            response.status = 200; // ok\r\n        } else {\r\n            response.status = 403; // forbidden\r\n        }\r\n    } else {\r\n        response.status = 404; // not found\r\n    }\r\n});\r\n\r\nconst createPoi = async (ctx, poi, response) => {\r\n    try {\r\n        const userId = ctx.state.user._id;\r\n        poi.userId = userId;\r\n        response.body = await poiStore.insert(poi);\r\n        response.status = 201; // created\r\n        broadcast(userId, {type: 'created', payload: poi});\r\n    } catch (err) {\r\n        response.body = {message: err.message};\r\n        response.status = 400; // bad request\r\n    }\r\n};\r\n\r\nrouter.post('/', async ctx => await createPoi(ctx, ctx.request.body, ctx.response));\r\n\r\nrouter.put('/:id', async (ctx) => {\r\n\r\n    // console.log(ctx.state);\r\n    // console.log(ctx.params);\r\n    // console.log(ctx.request);\r\n    // console.log(ctx.response);\r\n    // console.log(ctx.request.headers[\"if-modified-since\"]);\r\n\r\n    const poi = ctx.request.body;\r\n    const id = ctx.params.id;\r\n    const poiId = poi._id;\r\n    const response = ctx.response;\r\n    if (poiId && poiId !== id) {\r\n        response.body = {message: 'Param id and body _id should be the same'};\r\n        response.status = 400; // bad request\r\n        return;\r\n    }\r\n    if (!poiId) {\r\n        await createPoi(ctx, poi, response);\r\n    } else {\r\n        const userId = ctx.state.user._id;\r\n        poi.userId = userId;\r\n\r\n        // VERSIONING....\r\n        //const DB_POIS = await poiStore.findOne({_id: asteroidId});\r\n        // if (asteroid._version < DB_POIS._version) {\r\n        //     console.log(\"----------CONFLICT\")\r\n        //     ctx.response.body = {issue: [{error: `Version conflict`}]};\r\n        //     ctx.response.status = 409; // conflict\r\n        //     return;\r\n        // }\r\n        // asteroid._version++;\r\n\r\n        const updatedCount = await poiStore.update({_id: id}, poi);\r\n        if (updatedCount === 1) {\r\n            response.body = poi;\r\n            response.status = 200; // ok\r\n            broadcast(userId, {type: 'updated', payload: poi});\r\n        } else {\r\n            response.body = {message: 'Resource no longer exists'};\r\n            response.status = 405; // method not allowed\r\n        }\r\n    }\r\n});\r\n\r\nrouter.del('/:id', async (ctx) => {\r\n    const userId = ctx.state.user._id;\r\n    const poi = await poiStore.findOne({_id: ctx.params.id});\r\n    if (poi && userId !== poi.userId) {\r\n        ctx.response.status = 403; // forbidden\r\n    } else {\r\n        await poiStore.remove({_id: ctx.params.id});\r\n        ctx.response.status = 204; // no content\r\n    }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class PoiStore {\r\n  constructor({ filename, autoload }) {\r\n    this.store = dataStore({ filename, autoload });\r\n  }\r\n  \r\n  async find(props) {\r\n    return this.store.find(props);\r\n  }\r\n  \r\n  async findOne(props) {\r\n    return this.store.findOne(props);\r\n  }\r\n  \r\n  async insert(poi) {\r\n    let poiName = poi.name;\r\n    if (!poiName) { // validation\r\n      throw new Error('Missing poi name property')\r\n    }\r\n    return this.store.insert(poi);\r\n  };\r\n  \r\n  async update(props, poi) {\r\n    return this.store.update(props, poi);\r\n  }\r\n  \r\n  async remove(props) {\r\n    return this.store.remove(props);\r\n  }\r\n}\r\n\r\nexport default new PoiStore({ filename: './db/pois.json', autoload: true });","export const jwtConfig = { secret: 'my-secret' };\r\n","export * from './constants';\r\nexport * from './middlewares';\r\nexport * from './wss';\r\n","export const exceptionHandler = async (ctx, next) => {\r\n  try {\r\n    return await next();\r\n  } catch (err) {\r\n    ctx.body = { message: err.message || 'Unexpected error.' };\r\n    ctx.status = err.status || 500;\r\n  }\r\n};\r\n\r\nexport const timingLogger = async (ctx, next) => {\r\n  const start = Date.now();\r\n  await next();\r\n  console.log(`${ctx.method} ${ctx.url} => ${ctx.response.status}, ${Date.now() - start}ms`);\r\n};\r\n","import WebSocket from \"ws\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { jwtConfig } from \"./constants\";\r\n\r\nlet wss;\r\n\r\nexport const initWss = value => {\r\n  wss = value;\r\n  wss.on('connection', ws => {\r\n    ws.on('message', message => {\r\n      const { type, payload: { token } } = JSON.parse(message);\r\n      if (type !== 'authorization') {\r\n        ws.close();\r\n        return;\r\n      }\r\n      try {\r\n        ws.user = jwt.verify(token, jwtConfig.secret);\r\n      } catch (err) {\r\n        ws.close();\r\n      }\r\n    })\r\n  });\r\n};\r\n\r\nexport const broadcast = (userId, data) => {\r\n  if (!wss) {\r\n    return;\r\n  }\r\n  wss.clients.forEach(client => {\r\n    if (client.readyState === WebSocket.OPEN && userId === client.user._id) {\r\n      console.log(`broadcast sent to ${client.user.username}`);\r\n      client.send(JSON.stringify(data));\r\n    }\r\n  });\r\n};\r\n","module.exports = require(\"@koa/cors\");","module.exports = require(\"http\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-jwt\");","module.exports = require(\"koa-router\");","module.exports = require(\"nedb-promise\");","module.exports = require(\"ws\");"],"sourceRoot":""}